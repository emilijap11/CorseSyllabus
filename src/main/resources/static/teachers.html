<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Teachers</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <h1>All Teachers</h1>
    <div class="list-box">
        <div id="teachersList">Loading...</div>
    </div>
    <div class="courses-box" id="coursesBox">
        <div id="teacherCourses">Select a teacher to see courses.</div>
    </div>
    <div class="button-row">
        <button onclick="window.location.href='index.html'">â¬… Back</button>
        <button id="deleteSelectedBtn" style="display:none; width:120px;">Delete</button>
    </div>
</div>

<script>
    async function loadTeachers() {
        const list = document.getElementById("teachersList");
        const res = await fetch("/api/teachers");
        if (!res.ok) {
            list.innerText = "Error: Cannot load teachers.";
            list.className = "error";
            return;
        }
        const data = await res.json();
        if (!data || data.length === 0) {
            list.innerText = "No teachers found.";
            return;
        }
        list.innerHTML = "";
        data.forEach(t => {
            const div = document.createElement("div");
            div.className = "teacher-item";
            div.textContent = `${t.firstName || ""} ${t.lastName || ""}`.trim() + (t.email ? ` (${t.email})` : "");
            div.onclick = () => selectTeacher(t, div.textContent);
            list.appendChild(div);
        });
    }

    function renderTeacherHeader(teacherLabel, teacherTitle) {
        const header = document.createElement("div");
        const title = document.createElement("h3");
        title.className = "courses-title";
        title.textContent = `Courses for ${teacherLabel}`;
        const meta = document.createElement("div");
        meta.textContent = teacherTitle ? `Title: ${teacherTitle}` : "";
        header.appendChild(title);
        header.appendChild(meta);
        return header;
    }

    function renderTeacherEditForm(teacher) {
        const wrapper = document.createElement("div");
        wrapper.style.marginTop = "10px";
        wrapper.innerHTML = `
            <div class="page-subtitle">Edit Teacher</div>
            <input id="editTeacherFirst" placeholder="First Name" value="${teacher.firstName || ""}">
            <input id="editTeacherLast" placeholder="Last Name" value="${teacher.lastName || ""}">
            <input id="editTeacherEmail" placeholder="Email" value="${teacher.email || ""}">
            <input id="editTeacherTitle" placeholder="Title" value="${teacher.title || ""}">
            <button id="saveTeacherBtn">Save Changes</button>
        `;
        wrapper.querySelector("#saveTeacherBtn").onclick = async () => {
            const payload = {
                firstName: wrapper.querySelector("#editTeacherFirst").value.trim(),
                lastName: wrapper.querySelector("#editTeacherLast").value.trim(),
                email: wrapper.querySelector("#editTeacherEmail").value.trim(),
                title: wrapper.querySelector("#editTeacherTitle").value.trim()
            };
            if (!payload.firstName || !payload.lastName || !payload.email) {
                alert("Error: First name, last name and email are required.");
                return;
            }
            const res = await fetch(`/api/teachers/${teacher.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                alert("Error: Cannot update teacher.");
                return;
            }
            await loadTeachers();
            selectTeacher(teacher, `${payload.firstName} ${payload.lastName}` + (payload.email ? ` (${payload.email})` : ""));
        };
        return wrapper;
    }

    async function selectTeacher(teacher, teacherLabel) {
        const target = document.getElementById("teacherCourses");
        target.innerText = "Loading courses...";
        const res = await fetch(`/api/teachers/${teacher.id}/courses`);
        if (!res.ok) {
            target.innerText = "Error: Cannot load courses.";
            return;
        }
        const courses = await res.json();
        const header = renderTeacherHeader(teacherLabel, teacher.title);
        const ul = document.createElement("ul");
        if (!courses || courses.length === 0) {
            const li = document.createElement("li");
            li.textContent = "No courses found.";
            ul.appendChild(li);
        } else {
            courses.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.name || ""}`;
                ul.appendChild(li);
            });
        }
        target.innerHTML = "";
        target.appendChild(header);
        target.appendChild(renderTeacherEditForm(teacher));
        target.appendChild(ul);
        const deleteBtn = document.getElementById("deleteSelectedBtn");
        deleteBtn.style.display = "inline-block";
        deleteBtn.onclick = async () => deleteTeacher(teacher.id);
    }

    async function deleteTeacher(teacherId) {
        if (!confirm("Are you sure you want to delete this teacher?")) {
            return;
        }
        const res = await fetch(`/api/teachers/${teacherId}`, { method: "DELETE" });
        if (!res.ok) {
            alert("Error: Cannot delete teacher.");
            return;
        }
        document.getElementById("teacherCourses").innerText = "Select a teacher to see courses.";
        const deleteBtn = document.getElementById("deleteSelectedBtn");
        deleteBtn.style.display = "none";
        deleteBtn.onclick = null;
        loadTeachers();
    }

    loadTeachers();
</script>
</body>
</html>
